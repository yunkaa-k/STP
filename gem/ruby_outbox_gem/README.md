# RubyOutboxGem

Це Ruby-гем, що реалізує надійний архітектурний патерн **"Outbox"**. Він гарантує, що події (наприклад, для відправки в Kafka або API) будуть доставлені **атомарно** разом із вашими змінами в базі даних.


---

## Встановлення

1.  **Додайте гем**
    Додайте цей рядок до `Gemfile` вашого Rails-проєкту:

    ```ruby
    gem 'ruby_outbox_gem', path: '/шлях/до/вашого/гему/ruby_outbox_gem'
    # або, якщо б він був опублікований:
    # gem 'ruby_outbox_gem'
    ```

    А потім виконайте:
    ```bash
    bundle install
    ```

2.  **Налаштування Бази Даних**
    Цей гем вимагає таблицю для подій. Створіть міграцію у вашому Rails-проєкті:
    ```bash
    rails g migration CreateOutboxEvents
    ```
    Скопіюйте в неї вміст файлу `db/migrate/20240101000001_create_outbox_events.rb` з цього гему. Потім запустіть:
    ```bash
    rails db:migrate
    ```

---

## Використання

Гем надає два основні компоненти:

1.  **`RubyOutboxGem::Publisher`** — для атомарного збереження подій у вашій транзакції.
2.  **`RubyOutboxGem::Dispatcher`** — (використовується воркером) для надійної обробки та відправки цих подій.

Вам також потрібно налаштувати **обробники (handlers)**, щоб Диспатчер знав, *що* робити з кожною подією.

---

### Приклад (файл `demo.rb`):

Ось як можна налаштувати та виконати повний цикл (публікація + обробка).

```ruby
# frozen_string_literal: true
require "bundler/setup"

# --- 1. Налаштування (Імітація середовища Rails) ---
# У реальному додатку це не потрібно,
# оскільки ActiveRecord вже буде налаштований.
puts "[DEMO] Налаштування тестової БД в пам'яті..."
require_relative "spec/support/database" # Завантажуємо та запускаємо міграції
require_relative "lib/ruby_outbox_gem"    # Завантажуємо наш гем

# --- 2. Конфігурація Обробника ---
# Визначаємо, що робити, коли ми отримаємо подію 'UserRegistered'
RubyOutboxGem.configure do |config|
  config.handlers["UserRegistered"] = ->(payload) {
    puts "=============================================="
    puts "✅ ОБРОБНИК: Відправка email користувачу #{payload['user_id']}"
    puts "=============================================="
  }
end

# --- 3. Використання: Публікація події ---
# Це відбувається всередині вашого коду (наприклад, в Rails-контролері)
# в тій самій транзакції, де ви створюєте користувача.
puts "[DEMO] Публікація події 'UserRegistered'..."
RubyOutboxGem::Publisher.publish(
  "UserRegistered",
  { "user_id" => 42, "email" => "user@example.com" }
)
puts "[DEMO] Подію збережено в outbox_events."

# --- 4. Запуск Воркера (Диспатчера) ---
# У реальному додатку це працює в окремому процесі
# (запущеному через `bundle exec ruby_outbox_worker`),
# але тут ми запустимо його вручну для демонстрації.
puts "[DEMO] Запуск Диспатчера для обробки..."
RubyOutboxGem::Dispatcher.new.call
```
---
### Розробка та тестування
Якщо ви хочете вдосконалити або змінити функціонал гему:

Встановіть залежності розробки:
```
bundle install
```

Запустіть тести (RSpec), щоб перевірити коректність роботи:
```
bundle exec rspec
```

Ви також можете запустити демонстраційний скрипт, щоб побачити повний цикл "публікація-обробка" в дії:
```
bundle exec ruby manual_test.rb
```
